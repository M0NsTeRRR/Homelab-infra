---
- name: Open required ports
  ufw:
    rule: allow
    port: "9090"
    proto: tcp

- name: Install Prometheus
  apt:
    name: prometheus
    state: present

- name: Configure Prometheus
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
  notify: restart prometheus

- name: "Create {{ item.key }} folder in prometheus folder"
  file:
    state: directory
    name: "/etc/prometheus/{{ item.key }}"
  with_dict: "{{ prometheus_targets }}"

- name: "Create {{ item.key }} target file"
  template:
    src: targets.json.j2
    dest: "/etc/prometheus/{{ item.key }}/targets.json"
  with_dict: "{{ prometheus_targets }}"
  notify: restart prometheus

- name: Include certs
  include_tasks: certs.yml
  with_items: "{{ prometheus_clients_certs }}"