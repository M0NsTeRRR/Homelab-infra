---
- name: Install Prometheus
  ansible.builtin.apt:
    name: prometheus
    state: present

- name: Configure Prometheus
  ansible.builtin.lineinfile:
    dest: "/etc/default/prometheus"
    regexp: "^(# )?ARGS="
    line: 'ARGS="--web.listen-address=127.0.0.1:9090 --web.external-url=https://{{ inventory_hostname }}:9091"'
    state: "present"
  notify: restart prometheus

- name: Configure Prometheus
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
  notify: restart prometheus

- name: "Create {{ item.key }} folder in prometheus folder"
  ansible.builtin.file:
    state: directory
    name: "/etc/prometheus/{{ item.key }}"
  with_dict: "{{ prometheus_targets }}"

- name: "Create {{ item.key }} target file"
  ansible.builtin.template:
    src: targets.json.j2
    dest: "/etc/prometheus/{{ item.key }}/targets.json"
  with_dict: "{{ prometheus_targets }}"
  notify: restart prometheus

- name: Include certs
  ansible.builtin.include_tasks: certs.yml
  with_items: "{{ prometheus_clients_certs }}"