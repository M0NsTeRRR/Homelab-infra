---
- name: Install required packages
  ansible.builtin.apt:
    pkg:
      - git
      - golang
      - fping
    state: present

- name: Create fping folder
  ansible.builtin.file:
    state: directory
    name: /opt/exporter/fping/build

- name: Check if fping-exporter is already build
  ansible.builtin.stat:
    path: /usr/local/bin/fping-exporter
  register: fping_exporter

- name: Git clone
  ansible.builtin.git:
    repo: https://github.com/schweikert/fping-exporter.git
    dest: /opt/exporter/fping/build
  when: not fping_exporter.stat.exists or fping_exporter_force_install

- name: Compile sources
  ansible.builtin.shell: /usr/bin/go build -o /opt/exporter/fping/build
  args:
    chdir: /opt/exporter/fping/build
  when: not fping_exporter.stat.exists or fping_exporter_force_install

- name: Copy fping-exporter binary to /usr/local/bin
  ansible.builtin.copy:
    src: /opt/exporter/fping/build/fping-exporter
    dest: /usr/local/bin/fping-exporter
    owner: prometheus
    group: prometheus
    mode: 0700
    remote_src: yes
  when: not fping_exporter.stat.exists or fping_exporter_force_install
  notify: restart fping-exporter.service

- name: Create systemd service file
  ansible.builtin.template:
    src: fping-exporter.service.j2
    dest: /etc/systemd/system/fping-exporter.service
  notify:
    - enable fping-exporter.service
    - restart fping-exporter.service