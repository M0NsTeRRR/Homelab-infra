---
- name: Open required ports
  ufw:
    rule: allow
    port: "51820"
    proto: udp

- name: Add Debian buster-backports
  apt_repository:
    repo: "deb http://deb.debian.org/debian buster-backports main"
    state: present
    filename: buster-backports
  when: ansible_distribution == "Debian"

- name: Install Wireguard and Qrencode
  apt:
    pkg:
      - wireguard
      - qrencode
    state: present

- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    reload: yes

- name: Enable IPv6 forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: '1'
    reload: yes

- name: Setup clients
  include_tasks: clients.yml

- name: Setup interface and peers
  template:
    src: wg0.conf.j2
    dest: "/etc/wireguard/wg0.conf"
    mode: 0600
  notify:
    - restart wireguard
    - enable wireguard