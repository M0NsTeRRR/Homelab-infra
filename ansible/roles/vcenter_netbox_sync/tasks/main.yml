---
- name: Install required packages
  ansible.builtin.apt:
    pkg:
      - git
      - python3-pip
    state: present

- name: Install required python packages
  ansible.builtin.pip:
    name:
      - virtualenv

- name: Create vcenter-netbox-sync folder
  ansible.builtin.file:
    state: directory
    name: /opt/vcenter-netbox-sync

- name: Check if vcenter-netbox-sync is already installed
  ansible.builtin.stat:
    path: /opt/vcenter-netbox-sync/requirements.txt
  register: vcenter_netbox_sync

- name: "Download vcenter-netbox-sync version {{ vcenter_netbox_sync_version }}"
  ansible.builtin.get_url:
    url: "https://github.com/synackray/vcenter-netbox-sync/archive/v{{ vcenter_netbox_sync_version }}.tar.gz"
    dest: /tmp/vcenter-netbox-sync.tar.gz
  when: not vcenter_netbox_sync.stat.exists

- name: Extract vcenter-netbox-sync
  ansible.builtin.unarchive:
    src: /tmp/vcenter-netbox-sync.tar.gz
    dest: /opt/vcenter-netbox-sync
    remote_src: yes
    extra_opts: [--strip-components=1]
  when: not vcenter_netbox_sync.stat.exists

- name: Install vcenter-netbox-sync python packages
  ansible.builtin.pip:
    requirements: /opt/vcenter-netbox-sync/requirements.txt
    virtualenv: /opt/vcenter-netbox-sync/venv

- name: Configure vcenter-netbox-sync
  ansible.builtin.template:
    src: settings.py.j2
    dest: /opt/vcenter-netbox-sync/settings.py

- name: Configure vcenter-netbox-sync.service
  ansible.builtin.template:
    src: vcenter-netbox-sync.service.j2
    dest: /etc/systemd/system/vcenter-netbox-sync.service

- name: Configure vcenter-netbox-sync.timer
  ansible.builtin.template:
    src: vcenter-netbox-sync.timer.j2
    dest: /etc/systemd/system/vcenter-netbox-sync.timer
  notify:
    - restart vcenter-netbox-sync.timer
    - enable vcenter-netbox-sync.timer