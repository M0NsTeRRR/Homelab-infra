---
- name: Add graylog Apt signing key
  apt_key:
    url: "https://packages.graylog2.org/repo/debian/keyring.gpg"
    state: present
  retries: 3
  delay: 3

- name: Add graylog Apt repository
  apt_repository:
    repo: "deb https://packages.graylog2.org/repo/debian/ stable 3.3"
    state: present
    filename: graylog

- name: Install graylog-server
  apt:
    name: graylog-server
    state: present
  notify:
    - restart graylog-server
    - enable graylog-server

- name: Configure graylog-server
  lineinfile:
    dest: "/etc/graylog/server/server.conf"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: "present"
  with_items:
      - { regexp: '^(#)?password_secret =', line: 'password_secret = {{ graylog_password_secret }}' }
      - { regexp: '^(#)?root_password_sha2 =', line: 'root_password_sha2 = {{ graylog_root_password | hash("sha256") }}' }
      - { regexp: '^(#)?root_email =', line: 'root_email = {{ graylog_root_email }}' }
      - { regexp: '^(#)?root_timezone =', line: 'root_timezone = {{ graylog_root_timezone }}' }
      - { regexp: '^(#)?transport_email_enabled =', line: 'transport_email_enabled = {{ graylog_transport_email_enabled }}' }
      - { regexp: '^(#)?transport_email_hostname =', line: 'transport_email_hostname = {{ graylog_transport_email_hostname }}' }
      - { regexp: '^(#)?transport_email_port =', line: 'transport_email_port = {{ graylog_transport_email_port }}' }
      - { regexp: '^(#)?transport_email_use_auth =', line: 'transport_email_use_auth = {{ graylog_transport_email_use_auth }}' }
      - { regexp: '^(#)?transport_email_auth_username =', line: 'transport_email_auth_username = {{ graylog_transport_email_auth_username }}' }
      - { regexp: '^(#)?transport_email_auth_password =', line: 'transport_email_auth_password = {{ graylog_transport_email_auth_password }}' }
      - { regexp: '^(#)?transport_email_subject_prefix =', line: 'transport_email_subject_prefix = {{ graylog_transport_email_auth_password }}' }
      - { regexp: '^(#)?transport_email_from_email =', line: 'transport_email_from_email = {{ graylog_transport_email_from_email }}' }
      - { regexp: '^(#)?transport_email_use_tls =', line: 'transport_email_use_tls = {{ graylog_transport_email_use_tls }}' }
      - { regexp: '^(#)?transport_email_use_ssl =', line: 'transport_email_use_ssl = {{ graylog_transport_email_use_ssl }}' }
      - { regexp: '^(#)?transport_email_web_interface_url =', line: 'transport_email_web_interface_url = https://{{ ansible_hostname }}' }
  notify: restart graylog-server

- meta: flush_handlers

- name: Wait graylog-server restart
  uri:
    url: "https://{{ inventory_hostname }}"
    status_code: 200
    validate_certs: no
  register: result
  until: result.status == 200
  retries: 60
  delay: 1