---
- name: 'Provision Image'
  hosts: default
  become: true
  roles:
    - modprobe
    - grub
    - compiler
    - auditd
    - sysctl
    - ufw
    - motd
    - node_exporter
    - systemd_timesyncd
    - rsyslog
    - user
    - openssh_server
    - fail2ban
    - ca_certificates
  pre_tasks:
    - name: Update and upgrade all packages
      apt:
        upgrade: 'yes'
        update_cache: 'yes'
        autoclean: 'yes'
        autoremove: 'yes'

    - name: Include utils
      include_tasks: playbooks/utils.yml
  tasks:
    - name: "Update {{ main_user }} password"
      user:
        name: "{{ main_user }}"
        password: "{{ main_password | password_hash('sha512') }}"
        update_password: always